<!DOCTYPE html>
<html>
    <head>
        <title>MobArena Config Converter</title>
        <style type="text/css">
            @font-face { font-family: Cabin; src: url('Cabin-Regular.otf'); }
            body {
                color: #000000;
                background: #E3E6E6;
                font-family: Cabin;
                text-align: center;
            }
            textarea {
                width: 600pt;
                height: 200pt;
            }
            button {
                width: 600pt;
                height: 50pt;
                font-size: 18pt;
            }
            h2 {
                padding-top: 10pt;
                padding-bottom: 0pt;
                font-size: 18pt;
            }
        </style>
        <script>
            function getIndentLevel(lines) {
                var indent = "";
                for (var i = 0; i < lines.length; i++) {
                    var j = 0;
                    while (lines[i].charAt(j) == ' ') {
                        j++;
                    }
                    if (j > 0) {
                        for (var k = 0; k < j; k++) {
                            indent = indent + " ";
                        }
                        return indent;
                    }
                }
                return null;
            }

            function getSpawnpointsMap(indent, lines) {
                var in_waves  = false;
                var in_arenas = false;
                var arena = "";

                // arenas:
                // [  ]arena1:
                // [  ][  ]waves:
                // [  ][  ][  ]recurrent:
                // [  ][  ][  ][  ]def1:
                // [  ][  ][  ][  ][  ]spawnpoints:
                var re_arenas = new RegExp("^arenas:[\\s]*$");
                var re_arena  = new RegExp("^" + indent + "[\\S]+:[\\s]*$");
                var re_waves  = new RegExp("^" + indent + indent + "waves:[\\s]*$");
                var re_node   = new RegExp("^" + indent + indent + indent + indent + indent + "spawnpoints:.*$");

                // To check if we fall outside of the 'waves' block
                var waves_level = indent.length * 2;

                // Every arena has a map of old spawnpoint names to coord-names
                var map = {};

                for (var i = 0; i < lines.length; i++) {
                    // Skip all lines until we enter the 'arenas' block
                    if (!in_arenas) {
                        if (re_arenas.test(lines[i])) {
                            in_arenas = true;
                        }
                        continue;
                    }

                    // In case of odd ordering, ignore lines after 'arenas'
                    if (lines[i].charAt(0) != ' ') {
                        in_arenas = false;
                        continue;
                    }

                    // If we're in an arena-node, remember the name!
                    if (re_arena.test(lines[i])) {
                        var colon = lines[i].indexOf(':');
                        arena = lines[i].substring(0, colon).trim();
                        continue;
                    }

                    // Then skip all lines until we enter the 'waves' block
                    if (!in_waves) {
                        if (re_waves.test(lines[i])) {
                            in_waves = true;
                        }
                        continue;
                    }

                    // And if we exit the 'waves' block, start skipping again
                    if (lines[i].charAt(waves_level) != ' ') {
                        in_waves = false;
                        continue;
                    }

                    // We are in a 'waves' block, so look for 'spawnpoints'
                    if (re_node.test(lines[i])) {
                        var colon = lines[i].indexOf(':');
                        var value = lines[i].substring(colon + 2);

                        var parts = value.split(',');
                        for (var j = 0; j < parts.length; j++) {
                            // Lazily initialize the arena's map of spawnpoints
                            if (map[arena] == undefined) {
                                map[arena] = {};
                            }
                            map[arena][parts[j].trim()] = null;
                        }
                    }
                }
                return map;

            }

            function convert() {
                // Grab the properties string
                var prop = document.getElementById("old_config").value;
                if (prop.length == 0) {
                    alert("WHAT THE FUCK?!");
                    return;
                }

                // Split into lines
                var lines = prop.split("\n");

                // The indent level of this specific config-file
                var indent = getIndentLevel(lines);

                // The map of arenas to maps of (used) spawnpoints
                var map = getSpawnpointsMap(indent, lines);

                // Regexes for testing
                var re_arenas = new RegExp("^arenas:[\\s]*$");
                var re_arena  = new RegExp("^" + indent + "[\\S]+:[\\s]*$");
                var re_block  = new RegExp("^" + indent + indent + indent + "(spawnpoints|containers):.*$");
                var re_spawn  = new RegExp("^" + indent + indent + indent + indent + "[\\S]+: .+$");

                // Booleans for checks
                var in_arenas = false;
                var in_block  = false;

                // To check if we fall outside a block
                var block_level = indent.length * 3;

                // Current arena name
                var arena  = "";

                // Translation loop
                for (var i = 0; i < lines.length; i++) {
                    // Skip all lines until we enter the 'arenas' block
                    if (!in_arenas) {
                        if (re_arenas.test(lines[i])) {
                            in_arenas = true;
                        }
                        continue;
                    }

                    // In case of odd ordering, ignore lines after 'arenas'
                    if (lines[i].charAt(0) != ' ') {
                        in_arenas = false;
                        continue;
                    }

                    // If we're in an arena-node, remember the name!
                    if (re_arena.test(lines[i])) {
                        var colon = lines[i].indexOf(':');
                        arena = lines[i].substring(0, colon).trim();
                        continue;
                    }

                    // Then skip all lines until we enter the 'spawnpoints' block
                    if (!in_block) {
                        if (re_block.test(lines[i])) {
                            in_block = true;
                        }
                        continue;
                    }

                    // And if we exit the 'spawnpoints' block, start skipping again
                    if (lines[i].charAt(block_level) != ' ') {
                        in_block = false;
                        continue;
                    }

                    // Safeguard
                    if (!re_spawn.test(lines[i])) {
                        alert("WHAT THE FUCK?!");
                        continue;
                    }

                    // Find the colon and grab the name and value
                    var colon = lines[i].indexOf(":");
                    var name  = lines[i].substring(0, colon).trim();
                    var val   = lines[i].substring(colon + 2);

                    // Extract the parts and build the key
                    var parts = val.split(",");
                    var x = parts[0].split(".")[0];
                    var y = parts[1].split(".")[0];
                    var z = parts[2].split(".")[0];
                    var key = x + "," + y + "," + z;

                    // Replace the array entry
                    lines[i] = indent + indent + indent + indent + key + ": " + val;

                    // And create the mapping if necessary
                    if (map[arena] != undefined) {
                        if (map[arena][name] == null) {
                            map[arena][name] = key;
                        }
                    }
                }

                // Reset old variables
                in_arenas = false;
                in_block  = false;
                arena  = "";

                // Declare new ones
                var in_waves  = false;
                var sp_indent = indent + indent + indent + indent + indent;
                var re_waves  = new RegExp("^" + indent + indent + "waves:[\\s]*$");
                var re_node   = new RegExp("^" + sp_indent + "spawnpoints:.*$");
                var waves_level = indent.length * 2;

                /* Post-translation loop - this is where we replace all
                 * instances of the old spawnpoint names with the newly
                 * mapped names. */
                for (var i = 0; i < lines.length; i++) {
                    // Skip all lines until we enter the 'arenas' block
                    if (!in_arenas) {
                        if (re_arenas.test(lines[i])) {
                            in_arenas = true;
                        }
                        continue;
                    }

                    // In case of odd ordering, ignore lines after 'arenas'
                    if (lines[i].charAt(0) != ' ') {
                        in_arenas = false;
                        continue;
                    }

                    // If we're in an arena-node, remember the name!
                    if (re_arena.test(lines[i])) {
                        var colon = lines[i].indexOf(':');
                        arena = lines[i].substring(0, colon).trim();
                        continue;
                    }

                    // Then skip all lines until we enter the 'waves' block
                    if (!in_waves) {
                        if (re_waves.test(lines[i])) {
                            in_waves = true;
                        }
                        continue;
                    }

                    // And if we exit the 'waves' block, start skipping again
                    if (lines[i].charAt(waves_level) != ' ') {
                        in_waves = false;
                        continue;
                    }

                    // We are in a 'waves' block, so look for 'spawnpoints'
                    if (re_node.test(lines[i])) {
                        // Grab the value
                        var colon = lines[i].indexOf(":");
                        var val   = lines[i].substring(colon + 2);

                        // Split by comma to get all the spawnpoints
                        var parts = val.split(",");

                        // Build the value from each spawnpoint
                        val = "";
                        for (var j = 0; j < parts.length; j++) {
                            val = val + "; " + map[arena][parts[j].trim()];
                        }

                        // Cut off the first semicolon and space
                        val = val.substring(2);

                        // Then replace the line
                        lines[i] = sp_indent + "spawnpoints: " + val;
                    }
                }

                // Insert into the yml textarea
                document.getElementById("new_config").value = lines.join("\n");
            }
        </script>
    </head>
    <body>
        <h1>MobArena Config Converter v1.1</h1>
        <p>Copy and paste your config.yml file into the box below, then click Convert!</p>

        <h2>Old config.yml</h2>
        <textarea id="old_config"></textarea>

        <br/>
        <br/>
        <button onclick="convert()">Convert</button>

        <h2>New config.yml</h2>
        <textarea id="new_config"></textarea>
    </body>
</html>
